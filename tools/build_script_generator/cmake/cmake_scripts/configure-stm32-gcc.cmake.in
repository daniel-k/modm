INCLUDE(./modm/cmake/report-build-options.cmake)

SET(CMAKE_SYSTEM_NAME Generic)
SET(CMAKE_SYSTEM_PROCESSOR ARM)
SET(CMAKE_SYSTEM_NAME Linux)

# Configure toolchain
SET(TOOLCHAIN_PREFIX "arm-none-eabi-")

IF (MINGW OR CYGWIN OR WIN32)
    SET(TOOL_EXECUTABLE_SUFFIX ".exe")
	set(UTIL_SEARCH_CMD where)
ELSE()
    SET(TOOL_EXECUTABLE_SUFFIX "")
	set(UTIL_SEARCH_CMD which)
ENDIF()

execute_process(
  COMMAND ${UTIL_SEARCH_CMD} ${TOOLCHAIN_PREFIX}gcc
  OUTPUT_VARIABLE BINUTILS_PATH
  OUTPUT_STRIP_TRAILING_WHITESPACE
)

get_filename_component(ARM_TOOLCHAIN_DIR ${BINUTILS_PATH} DIRECTORY)

IF(${CMAKE_VERSION} VERSION_LESS 3.6.0)
    INCLUDE(CMakeForceCompiler)
    CMAKE_FORCE_C_COMPILER("${TOOLCHAIN_PREFIX}gcc${TOOL_EXECUTABLE_SUFFIX}" GNU)
    CMAKE_FORCE_CXX_COMPILER("${TOOLCHAIN_PREFIX}g++${TOOL_EXECUTABLE_SUFFIX}" GNU)
ELSE()
    SET(CMAKE_TRY_COMPILE_TARGET_TYPE STATIC_LIBRARY)
    SET(CMAKE_C_COMPILER "${TOOLCHAIN_PREFIX}gcc${TOOL_EXECUTABLE_SUFFIX}")
    SET(CMAKE_CXX_COMPILER "${TOOLCHAIN_PREFIX}g++${TOOL_EXECUTABLE_SUFFIX}")
ENDIF()

SET(CMAKE_LINKER       "${TOOLCHAIN_PREFIX}g++${TOOL_EXECUTABLE_SUFFIX}" CACHE INTERNAL "linker tool")
SET(CMAKE_ASM_COMPILER "${TOOLCHAIN_PREFIX}gcc${TOOL_EXECUTABLE_SUFFIX}" CACHE INTERNAL "ASM compiler")
SET(CMAKE_OBJCOPY      "${TOOLCHAIN_PREFIX}objcopy${TOOL_EXECUTABLE_SUFFIX}" CACHE INTERNAL "objcopy tool")
SET(CMAKE_OBJDUMP      "${TOOLCHAIN_PREFIX}objdump${TOOL_EXECUTABLE_SUFFIX}" CACHE INTERNAL "objdump tool")
SET(CMAKE_SIZE         "${TOOLCHAIN_PREFIX}size${TOOL_EXECUTABLE_SUFFIX}" CACHE INTERNAL "size tool")
SET(CMAKE_DEBUGER      "${TOOLCHAIN_PREFIX}gdb${TOOL_EXECUTABLE_SUFFIX}" CACHE INTERNAL "debuger")
SET(CMAKE_CPPFILT      "${TOOLCHAIN_PREFIX}c++filt${TOOL_EXECUTABLE_SUFFIX}" CACHE INTERNAL "C++filt")
SET(CMAKE_SHARED_LIBRARY_LINK_C_FLAGS "")
SET(CMAKE_SHARED_LIBRARY_LINK_CXX_FLAGS "")

set(CMAKE_FIND_ROOT_PATH ${BINUTILS_PATH})
SET(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
SET(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
SET(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)

# Prepare linker script

SET(LINKER_SCRIPT_NAME linkerscript.ld)
SET(LINKER_SCRIPT ${CMAKE_CURRENT_BINARY_DIR}/${LINKER_SCRIPT_NAME})
CONFIGURE_FILE(modm/link/${LINKER_SCRIPT_NAME} ${LINKER_SCRIPT})

# Toolchain configuration
%% macro generate_flags_for_profile(name, profile, suffix="")
SET({{name}}{{ "_" ~ (suffix | upper) if suffix | length else "" }} "\
%% for flag in flags[name][profile] | sort
    {{ flag | flag_format }} \
%% endfor
")
%% endmacro

%% macro generate_flags(name)
{{ generate_flags_for_profile(name, "base") }}
%% for profile in flags[name].keys()
%% if profile != "base"
{{ generate_flags_for_profile(name, profile, suffix=profile) }}
%% endif
%% endfor
%% endmacro

{{ generate_flags("CCFLAGS") }}
{{ generate_flags("CFLAGS") }}
{{ generate_flags("CXXFLAGS") }}
{{ generate_flags("ASFLAGS") }}
{{ generate_flags("ARCHFLAGS") }}
{{ generate_flags("LINKFLAGS") }}

# Set flags for CMake
SET(CMAKE_C_FLAGS "${ARCHFLAGS} ${CCFLAGS} ${CFLAGS}" CACHE INTERNAL "c compiler flags")
SET(CMAKE_C_FLAGS_RELEASE   "${CCFLAGS_RELEASE}"      CACHE INTERNAL "c compiler flags release")
SET(CMAKE_C_FLAGS_DEBUG     "${CCFLAGS_DEBUG}"        CACHE INTERNAL "c compiler flags debug")

SET(CMAKE_CXX_FLAGS "${ARCHFLAGS} ${CCFLAGS} ${CXXFLAGS}" CACHE INTERNAL "cxx compiler flags")
SET(CMAKE_CXX_FLAGS_RELEASE "${CCFLAGS_RELEASE}"          CACHE INTERNAL "cxx compiler flags release")
SET(CMAKE_CXX_FLAGS_DEBUG   "${CCFLAGS_DEBUG}"            CACHE INTERNAL "cxx compiler flags debug")

SET(CMAKE_ASM_FLAGS "${ARCHFLAGS} ${ASFLAGS}" CACHE INTERNAL "asm compiler flags")

SET(CMAKE_EXE_LINKER_FLAGS  "${ARCHFLAGS} ${LINKFLAGS}" CACHE INTERNAL "linker flags")
